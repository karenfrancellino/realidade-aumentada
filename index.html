<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- A-Frame principal -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- AR.js versi√≥n estable -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>

  <!-- A-Frame Extras (opcional, utilidades) -->
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <!-- ===========================
       ESCENA AFRAME + AR
       =========================== -->
  <a-scene
      embedded
      renderer="preserveDrawingBuffer: true; alpha: true;" 
      arjs="sourceType: webcam; debugUIEnabled: false;">

      <!-- Marcador Hiro -->
      <a-marker preset="hiro">
        <!-- Entidad 3D con animaci√≥n -->
        <a-entity
          id="personagem"
          gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
          scale="2 2 2"
          position="0 0.5 0"
          animation-mixer="clip: SickJacken_rigAction; loop: repeat; timeScale: 1">
        </a-entity>
      </a-marker>

      <!-- C√°mara principal -->
      <a-entity camera></a-entity>
  </a-scene>

  <!-- ===========================
       BOTONES DE FOTO Y V√çDEO
       =========================== -->
  <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:space-around; z-index:999;">
    <button id="btnFoto" style="padding:15px; background:white; border-radius:10px;">üì∏ Hacer foto</button>
    <button id="btnVideo" style="padding:15px; background:white; border-radius:10px;">üî¥ V√≠deo</button>
  </div>

  <!-- ===========================
       SCRIPT PRINCIPAL
       =========================== -->
  <script>
    // ===== Selecci√≥n de elementos
    const sceneEl = document.querySelector('a-scene'); // Escena principal A-Frame
    const btnFoto = document.querySelector('#btnFoto'); // Bot√≥n de foto
    const btnVideo = document.querySelector('#btnVideo'); // Bot√≥n de v√≠deo
    let mediaRecorder; // MediaRecorder para v√≠deo
    let chunks = [];   // Array donde guardaremos los fragmentos de v√≠deo

    // ===== LOG DE CARGA DE MODELO
    document.querySelector('#personagem').addEventListener('model-loaded', (e) => {
      console.log('Modelo cargado correctamente');
      const model = e.detail.model;
      if (model.animations.length > 0) {
        console.log('Animaciones disponibles:', model.animations.map(a => a.name));
      } else {
        console.warn('Este modelo no tiene animaciones internas');
      }
    });

    // ===== FUNCI√ìN PARA TOMAR FOTO (c√°mara + 3D)
    btnFoto.addEventListener('click', () => {
      if (!sceneEl.renderer) return; // Verificamos que el renderer est√© listo

      // Obtenemos el v√≠deo de la c√°mara AR.js
      const video = sceneEl.systems.arjs.arController.video;

      // Obtenemos el canvas donde A-Frame renderiza el 3D
      const canvas3d = sceneEl.renderer.domElement;

      // Creamos un canvas temporal para fusionar c√°mara + 3D
      const merger = document.createElement('canvas');
      merger.width = canvas3d.width;
      merger.height = canvas3d.height;
      const ctx = merger.getContext('2d');

      // Esperamos al siguiente frame para asegurarnos de que el canvas 3D se ha renderizado
      requestAnimationFrame(() => {
        // Dibujamos primero el v√≠deo de la c√°mara (fondo)
        ctx.drawImage(video, 0, 0, merger.width, merger.height);
        // Dibujamos encima el canvas del 3D (personaje)
        ctx.drawImage(canvas3d, 0, 0);

        // Creamos enlace para descargar la imagen
        const link = document.createElement('a');
        link.download = 'ar-foto.png';
        link.href = merger.toDataURL('image/png');
        link.click();

        // Feedback visual temporal
        btnFoto.textContent = '‚úÖ Foto guardada';
        setTimeout(() => { btnFoto.textContent = 'üì∏ Hacer foto'; }, 1500);
      });
    });

    // ===== FUNCI√ìN PARA GRABAR V√çDEO (c√°mara + 3D)
    btnVideo.addEventListener('click', () => {
      if (!sceneEl.renderer) return; // Verificamos que el renderer est√© listo

      // Canvas del 3D
      const canvas3d = sceneEl.renderer.domElement;

      // Si no hay grabaci√≥n activa, la iniciamos
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        chunks = []; // Limpiamos datos anteriores

        // Creamos canvas temporal para combinar c√°mara + 3D en cada frame
        const video = sceneEl.systems.arjs.arController.video;
        const merger = document.createElement('canvas');
        merger.width = canvas3d.width;
        merger.height = canvas3d.height;
        const ctx = merger.getContext('2d');

        // Capturamos frames del canvas temporal a 30 FPS
        const fps = 30;
        const stream = merger.captureStream(fps);
        mediaRecorder = new MediaRecorder(stream);

        // Guardamos cada fragmento
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

        // Al parar la grabaci√≥n, generamos el archivo final
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ar-video.webm';
          a.click();
          URL.revokeObjectURL(url);
        };

        // Actualizamos bot√≥n y empezamos grabaci√≥n
        mediaRecorder.start();
        btnVideo.style.background = 'red';
        btnVideo.textContent = '‚èπ Detener grabaci√≥n';

        // Funci√≥n para dibujar en el canvas temporal cada frame
        function drawFrame() {
          ctx.drawImage(video, 0, 0, merger.width, merger.height); // c√°mara
          ctx.drawImage(canvas3d, 0, 0); // 3D
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            requestAnimationFrame(drawFrame); // siguiente frame
          }
        }
        requestAnimationFrame(drawFrame); // empezamos loop
      } else {
        // Si ya est√° grabando, paramos
        mediaRecorder.stop();
        mediaRecorder = null;
        btnVideo.style.background = 'white';
        btnVideo.textContent = 'üî¥ V√≠deo';
      }
    });
  </script>
</body>
</html>
