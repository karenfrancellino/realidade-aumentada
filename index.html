<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene 
    embedded 
    renderer="preserveDrawingBuffer: true; alpha: true; antialias: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">

    <a-marker preset="hiro">
      <a-entity
        id="personagem"
        gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
        scale="2 2 2"
        position="0 0.5 0"
        visible="false"> </a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
  </a-scene>

  <div style="position:absolute; bottom:30px; width:100%; display:flex; justify-content:space-evenly; z-index:9999;">
    <button id="btnFoto" style="padding:15px 25px; background:#fff; border-radius:30px; border:none; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">萄 FOTO</button>
    <button id="btnVideo" style="padding:15px 25px; background:#fff; border-radius:30px; border:none; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">閥 Vﾃ好EO</button>
  </div>

  <script>
    const scene = document.querySelector('a-scene');
    const model = document.querySelector('#personagem');
    const btnFoto = document.querySelector('#btnFoto');
    const btnVideo = document.querySelector('#btnVideo');
    let recorder;
    let chunks = [];

    // --- 1. GERENCIAMENTO DE CARREGAMENTO E ANIMAﾃﾃグ ---
    model.addEventListener('model-loaded', () => {
  console.log("Modelo GLB carregado com sucesso.");
  model.setAttribute('visible', 'true'); // Torna visﾃｭvel sﾃｳ apﾃｳs carregar

  // Ativa a animaﾃｧﾃ｣o com o nome correto
  model.setAttribute('animation-mixer', {
    clip: "SickJacken_rigAction", // nome exato da animaﾃｧﾃ｣o
    loop: "repeat",               // loop infinito
    timeScale: 1                  // velocidade normal
  });
});

    // --- 2. FUNﾃﾃグ DE CAPTURA DE TELA (MERGE) ---
    btnFoto.addEventListener('click', () => {
      // Capturamos o vﾃｭdeo da webcam (gerado pelo AR.js) e o canvas 3D (A-Frame)
      const video = document.querySelector('video');
      const canvas3d = scene.renderer.domElement;
      
      const merger = document.createElement('canvas');
      merger.width = canvas3d.width;
      merger.height = canvas3d.height;
      const ctx = merger.getContext('2d');

      // Ordem de desenho: 1ﾂｺ Cﾃ｢mera, 2ﾂｺ Personagem
      ctx.drawImage(video, 0, 0, merger.width, merger.height);
      ctx.drawImage(canvas3d, 0, 0);

      const link = document.createElement('a');
      link.download = 'captura-ar.png';
      link.href = merger.toDataURL('image/png');
      link.click();
    });

    // --- 3. GRAVAﾃﾃグ DE Vﾃ好EO (LOOP DE RENDERIZAﾃﾃグ) ---
    btnVideo.addEventListener('click', () => {
      if (!recorder || recorder.state === 'inactive') {
        const video = document.querySelector('video');
        const canvas3d = scene.renderer.domElement;
        
        // Criamos um canvas de saﾃｭda que serﾃ｡ gravado
        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = canvas3d.width;
        outputCanvas.height = canvas3d.height;
        const ctx = outputCanvas.getContext('2d');

        // Captura o stream do canvas que estamos desenhando manualmente
        const stream = outputCanvas.captureStream(30);
        recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'video-ar.webm';
          a.click();
        };

        // LOOP MANUAL: Desenha cﾃ｢mera + 3D no canvas de saﾃｭda 30 vezes por segundo
        function renderLoop() {
          if (recorder && recorder.state === 'recording') {
            ctx.drawImage(video, 0, 0, outputCanvas.width, outputCanvas.height);
            ctx.drawImage(canvas3d, 0, 0);
            requestAnimationFrame(renderLoop);
          }
        }

        recorder.start();
        renderLoop();
        btnVideo.textContent = "竢ｹ PARAR";
        btnVideo.style.background = "#ff4d4d";
      } else {
        recorder.stop();
        btnVideo.textContent = "閥 Vﾃ好EO";
        btnVideo.style.background = "#fff";
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene 
    embedded 
    vr-mode-ui="enabled: false"
    renderer="preserveDrawingBuffer: true; alpha: true; logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;">

    <a-marker preset="hiro">
      <a-entity
        id="personagem"
        gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
        scale="2 2 2"
        position="0 0.5 0"
        animation-mixer="clip: SickJacken_rigAction; loop: repeat">
      </a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
  </a-scene>

  <div style="position:absolute; bottom:30px; width:100%; display:flex; justify-content:space-evenly; z-index:9999;">
    <button id="btnFoto" style="padding:15px 25px; background:#fff; border-radius:30px; border:none; font-weight:bold;">萄 FOTO</button>
    <button id="btnVideo" style="padding:15px 25px; background:#fff; border-radius:30px; border:none; font-weight:bold;">閥 Vﾃ好EO</button>
  </div>

  <script>
    const scene = document.querySelector('a-scene');
    const model = document.querySelector('#personagem');
    const btnFoto = document.querySelector('#btnFoto');
    const btnVideo = document.querySelector('#btnVideo');
    let recorder;
    let chunks = [];

    // --- SOLUﾃﾃグ PARA O Vﾃ好EO E FOTO PRETA ---
    // Esta funﾃｧﾃ｣o cria o merge real da cﾃ｢mera + 3D
    function getMergedCanvas() {
      const video = document.querySelector('video');
      const canvas3d = scene.renderer.domElement;
      const merger = document.createElement('canvas');
      merger.width = canvas3d.width;
      merger.height = canvas3d.height;
      const ctx = merger.getContext('2d');

      // Desenha a webcam
      ctx.drawImage(video, 0, 0, merger.width, merger.height);
      // Desenha o personagem
      ctx.drawImage(canvas3d, 0, 0);
      return merger;
    }

    btnFoto.addEventListener('click', () => {
      const mergedCanvas = getMergedCanvas();
      const link = document.createElement('a');
      link.download = 'captura-ar.png';
      link.href = mergedCanvas.toDataURL('image/png');
      link.click();
    });

    btnVideo.addEventListener('click', () => {
      if (!recorder || recorder.state === 'inactive') {
        const mergedCanvasForVideo = document.createElement('canvas');
        mergedCanvasForVideo.width = scene.renderer.domElement.width;
        mergedCanvasForVideo.height = scene.renderer.domElement.height;
        const ctx = mergedCanvasForVideo.getContext('2d');
        const videoElement = document.querySelector('video');
        const canvas3d = scene.renderer.domElement;

        const stream = mergedCanvasForVideo.captureStream(30);
        recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'video-ar.webm';
          a.click();
        };

        recorder.start();
        btnVideo.textContent = "竢ｹ PARAR";

        // Loop de renderizaﾃｧﾃ｣o para o vﾃｭdeo nﾃ｣o sair preto
        function step() {
          if (recorder && recorder.state === 'recording') {
            ctx.drawImage(videoElement, 0, 0, mergedCanvasForVideo.width, mergedCanvasForVideo.height);
            ctx.drawImage(canvas3d, 0, 0);
            requestAnimationFrame(step);
          }
        }
        step();
      } else {
        recorder.stop();
        btnVideo.textContent = "閥 Vﾃ好EO";
      }
    });

    // --- FORﾃ②R ANIMAﾃﾃグ ---
    model.addEventListener('model-loaded', () => {
      // Pequeno delay para evitar o conflito do MatrixMode do AR.js
      setTimeout(() => {
        model.setAttribute('animation-mixer', 'clip: SickJacken_rigAction; loop: repeat');
      }, 1000);
    });
  </script>
</body>
</html>
