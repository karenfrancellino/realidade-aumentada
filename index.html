<!DOCTYPE html> <!-- Diz que o documento Ã© HTML5 -->

<html>
  <head> <!-- Ãrea de configuraÃ§Ãµes e importaÃ§Ãµes do projeto -->
    <!-- Define que o texto da pÃ¡gina usa UTF-8 (acentos e emojis nÃ£o quebram) -->
    <meta charset="utf-8">
    <!-- Ajusta a visualizaÃ§Ã£o em celulares para ocupar toda a tela -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Permite que a pÃ¡gina funcione como "app" no iPhone -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Permite que a pÃ¡gina funcione como "app" no Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Importa A-Frame â†’ a biblioteca que cria objetos 3D -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- Permite movimento do personagem -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <!-- Importa AR.js â†’ a biblioteca que ativa a Realidade Aumentada -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
     <!-- Importa biblioteca para screenshot-->
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    <!-- Ferramenta para acionar tela ceheia nos dispositivos maiores-->
<style>
  canvas {
    width: 100% !important;
    height: 100% !important;
    left: 0 !important;
    top: 0 !important;
    position: absolute !important;
  }
  video {
    width: 100vw !important;
    height: 100vh !important;
    object-fit: cover !important; /* Faz o vÃ­deo preencher sem distorcer */
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
  }
</style>
  </head>
  <!-- O que aparece na tela comeÃ§a no body + margin:0 â†’ tira margens da pÃ¡gina + overflow:hidden â†’ remove barras de rolagem para a cÃ¢mera ocupar a tela -->
  <body style="margin:0; overflow:hidden;">
    <!-- Inicia a cena 3D + AR.js + Impede modo VR e deixa cena embutida na pÃ¡gina + Diz que a fonte do vÃ­deo Ã© a webcam/cÃ¢mera -->
   <a-scene 
 embedded 
  arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;" 
  renderer="preserveDrawingBuffer: true; antialias: true; alpha: true; logarithmicDepthBuffer: true;"
  vr-mode-ui="enabled: false"> <!-- videoTexture: true funde a cena do personagem com a da camera + preserveDrawingBuffer: true;Impede que o navegador limpe o buffer do desenho logo apÃ³s renderizar -->
      <!-- MARCADOR HIRO + Quando a cÃ¢mera detectar o marcador Hiro, tudo dentro aparece -->
      <a-marker preset="hiro">
        <!-- Adiciona id ao personagem + OBJETO 3D + Um personagem droys posicionada 0.5m acima do marcador -->
  <a-entity
    id="personagem"
    gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
    scale="3 3 3"
    position="0 0.5 0"
    animation-mixer>
  </a-entity>
      </a-marker>
      <!-- CÃ‚MERA + A cÃ¢mera usada para visualizar a RA -->
      <a-entity camera></a-entity>
  </a-scene>
     <!-- Ancora para os botoes -->
      <div style="position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 10000; pointer-events: none;">
     <!-- Botao screenshot -->
    <button id="btnScreenshot" style="pointer-events: auto; padding: 15px 20px; background: white; border-radius: 12px; border: 2px solid #333; font-weight: bold; box-shadow: 0px 4px 6px rgba(0,0,0,0.2);">
      ðŸ“¸ Sacar Foto
    </button>
    <!-- Botao gravaÃ§ao de tela -->
    <button id="btnRecord" style="pointer-events: auto; padding: 15px 20px; background: white; border-radius: 12px; border: 2px solid #333; font-weight: bold; box-shadow: 0px 4px 6px rgba(0,0,0,0.2);">
      ðŸ”´ Grabar VÃ­deo
    </button>
</div>

    <script>
      // SeleÃ§Ã£o de elementos do DOM e definiÃ§Ã£o de estados globais
      const personagem = document.querySelector('#personagem');
      const btnFoto = document.querySelector('#btnScreenshot');
      const btnVideo = document.querySelector('#btnRecord');
      const SickJacken_rigAction = "SickJacken_rigAction";
      
      let gravador;
      let gravando = false;

      // Gerenciamento de ciclo de vida do modelo 3D e ativaÃ§Ã£o de animaÃ§Ãµes
      personagem.addEventListener('model-loaded', (e) => {
        const model = e.detail.model;
        const animations = model.animations;
        if (animations.length > 0) {
          personagem.setAttribute('animation-mixer', {
            clip: SickJacken_rigAction,
            loop: 'repeat'
          });
        }
      });

      // ImplementaÃ§Ã£o da captura de tela com fusÃ£o de buffers (Camada VÃ­deo + Camada Canvas)
      btnFoto.addEventListener('click', () => {
    const scene = document.querySelector('a-scene');
    const video = document.querySelector('video'); 
    const canvas = scene.canvas;

        if (canvas && video) {
         scene.renderer.render(scene.object3D, scene.camera);
          // InicializaÃ§Ã£o de buffer temporÃ¡rio para composiÃ§Ã£o de imagem
          const outputCanvas = document.createElement('canvas');
          outputCanvas.width = canvas.width;
          outputCanvas.height = canvas.height;
          const ctx = outputCanvas.getContext('2d');

          // RenderizaÃ§Ã£o sequencial: fundo (webcam) seguido do foreground (3D)
          ctx.drawImage(video, 0, 0, outputCanvas.width, outputCanvas.height);
          ctx.drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);
          
          // ExtraÃ§Ã£o do buffer composto para formato DataURL e execuÃ§Ã£o do download
          const imagemFinal = outputCanvas.toDataURL("image/png");
          const link = document.createElement('a');
          link.download = "foto-ar.png";
          link.href = imagemFinal;
          link.click();
          
          alert('Foto capturada con Ã©xito!');
        } else {
          console.error("ReferÃªncia de Canvas ou VÃ­deo nÃ£o encontrada.");
        }
      });

      // Controle de fluxo de gravaÃ§Ã£o de fluxo de mÃ­dia (MediaStream) do Canvas
      btnVideo.addEventListener('click', () => {
        const canvas = document.querySelector('canvas');
        if (!canvas) return;

        if (!gravando) {
          // Captura do stream de frames do canvas a 30 FPS e inicializaÃ§Ã£o do RecordRTC
          const fluxo = canvas.captureStream(30); 
          gravador = new RecordRTC(fluxo, {
            type: 'video',
            mimeType: 'video/webm'
          });

          gravador.startRecording();
          gravando = true;
          
          // AtualizaÃ§Ã£o visual do estado da interface
          btnVideo.textContent = 'â¹ Detener GravaciÃ³n';
          btnVideo.style.backgroundColor = 'red';
          btnVideo.style.color = 'white';
        } else {
          // FinalizaÃ§Ã£o da captura, geraÃ§Ã£o de Blob e disponibilizaÃ§Ã£o para download
          gravador.stopRecording(() => {
            const arquivoVideo = gravador.getBlob();
            const urlVideo = URL.createObjectURL(arquivoVideo);
            const linkDownload = document.createElement('a');
            linkDownload.href = urlVideo;
            linkDownload.download = 'video-ar.webm';
            linkDownload.click();

            // Reset do estado global de gravaÃ§Ã£o e interface
            gravando = false;
            btnVideo.textContent = 'ðŸ”´ Grabar VÃ­deo';
            btnVideo.style.backgroundColor = 'white';
            btnVideo.style.color = 'black';
          });
        }
      });
    </script>
  </body>
</html>
