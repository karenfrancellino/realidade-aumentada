<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script> <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script> <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script> </head>

<body style="margin:0; overflow:hidden;"> <a-scene 
    embedded 
    renderer="preserveDrawingBuffer: true; alpha: true;" 
    arjs="sourceType: webcam; debugUIEnabled: false;">

    <a-marker preset="hiro"> <a-entity
        id="personagem"
        gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
        scale="2 2 2"
        position="0 0.5 0"
        animation-mixer="clip: SickJacken_rigAction; loop: repeat"> </a-entity>
    </a-marker>
    
    <a-entity camera></a-entity> </a-scene>

  <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:space-around; z-index:999;">
    <button id="btnFoto" style="padding:15px; background:white; border-radius:10px;">萄 Foto</button>
    <button id="btnVideo" style="padding:15px; background:white; border-radius:10px;">閥 Vﾃｭdeo</button>
  </div>

  <script>
    const sceneEl = document.querySelector('a-scene'); // Seleciona a cena
    const btnFoto = document.querySelector('#btnFoto'); // Seleciona botﾃ｣o foto
    const btnVideo = document.querySelector('#btnVideo'); // Seleciona botﾃ｣o vﾃｭdeo
    let mediaRecorder; // Variﾃ｡vel para o gravador
    let chunks = []; // Array para dados do vﾃｭdeo

    // --- FUNﾃﾃグ PARA PEGAR FOTO (Cﾃ｢mera + 3D) ---
    btnFoto.addEventListener('click', () => {
      const video = document.querySelector('video'); // Acessa o stream da webcam
      const canvas3d = sceneEl.canvas; // Acessa o canvas onde o boneco estﾃ｡
      
      const merger = document.createElement('canvas'); // Cria um canvas temporﾃ｡rio
      merger.width = canvas3d.width; // Define largura igual ao 3D
      merger.height = canvas3d.height; // Define altura igual ao 3D
      const ctx = merger.getContext('2d'); // Contexto de desenho 2D

      ctx.drawImage(video, 0, 0, merger.width, merger.height); // Passo 1: Desenha a webcam ao fundo
      ctx.drawImage(canvas3d, 0, 0); // Passo 2: Desenha o personagem por cima

      const link = document.createElement('a'); // Link para download
      link.download = 'ar-foto.png'; // Nome do arquivo
      link.href = merger.toDataURL('image/png'); // Converte para imagem
      link.click(); // Dispara o download
    });

    // --- FUNﾃﾃグ PARA Vﾃ好EO ---
    btnVideo.addEventListener('click', () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        chunks = []; // Reseta os dados
        const stream = sceneEl.canvas.captureStream(30); // Captura o canvas em 30 FPS
        mediaRecorder = new MediaRecorder(stream); // Inicia o gravador

        mediaRecorder.ondataavailable = e => chunks.push(e.data); // Salva pacotes de vﾃｭdeo
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' }); // Gera o arquivo final
          const url = URL.createObjectURL(blob); // Cria link do vﾃｭdeo
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ar-video.webm';
          a.click(); // Baixa o vﾃｭdeo
        };

        mediaRecorder.start(); // Comeﾃｧa a gravar
        btnVideo.style.background = 'red'; // Muda cor do botﾃ｣o
        btnVideo.textContent = '竢ｹ Parar';
      } else {
        mediaRecorder.stop(); // Para a gravaﾃｧﾃ｣o
        btnVideo.style.background = 'white';
        btnVideo.textContent = '閥 Vﾃｭdeo';
      }
    });

    // --- LOG DE DEPURAﾃﾃグ (Verifica se o modelo carregou e tem animaﾃｧﾃ｣o) ---
    document.querySelector('#personagem').addEventListener('model-loaded', (e) => {
      console.log('Modelo OK!'); // Confirma que o arquivo .glb foi lido
      const model = e.detail.model;
      if (model.animations.length > 0) {
        console.log('Animaﾃｧﾃｵes:', model.animations.map(a => a.name)); // Lista nomes das animaﾃｧﾃｵes no console
      } else {
        console.error('Este modelo nﾃ｣o tem animaﾃｧﾃｵes internas!'); // Alerta se o arquivo estiver vazio
      }
    });
  </script>
</body>
</html>
