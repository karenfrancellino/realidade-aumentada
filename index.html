<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script> <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script> <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script> </head>

<body style="margin:0; overflow:hidden;"> <a-scene 
        embedded 
        vr-mode-ui="enabled: false"
        renderer="preserveDrawingBuffer: true; alpha: true; antialias: true;" 
        arjs="sourceType: webcam; debugUIEnabled: false;">

        <a-marker preset="hiro"> <a-entity
                id="personaje"
                gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
                scale="2 2 2"
                position="0 0.5 0"
                animation-mixer="clip: SickJacken_rigAction; loop: repeat"> </a-entity>
        </a-marker>
        
        <a-entity camera></a-entity> </a-scene>

    <div style="position:fixed; bottom:30px; width:100%; display:flex; justify-content:space-around; z-index:10000;">
        <button id="btnFoto" style="padding:20px; border-radius:50%; background:white; border:none; box-shadow:0 4px 15px rgba(0,0,0,0.4); font-size:24px;"></button>
        <button id="btnVideo" style="padding:20px; border-radius:50%; background:white; border:none; box-shadow:0 4px 15px rgba(0,0,0,0.4); font-size:24px;"></button>
    </div>

    <script>
        const escena = document.querySelector('a-scene'); // Referencia de la escena A-Frame
        const btnFoto = document.querySelector('#btnFoto'); // Referencia del bot贸n de foto
        const btnVideo = document.querySelector('#btnVideo'); // Referencia del bot贸n de v铆deo
        let grabador; // Instancia del grabador MediaRecorder
        let fragmentos = []; // Array para almacenar los fragmentos (chunks) de v铆deo

        // --- LGICA DE FOTO (CAPTURA DE PANTALLA) ---
        btnFoto.addEventListener('click', () => {
            const video = document.querySelector('video'); // Accede al elemento de v铆deo de la webcam
            const canvas3D = escena.renderer.domElement; // Accede al canvas WebGL donde est谩 el personaje
            
            const mergeCanvas = document.createElement('canvas'); // Crea un canvas temporal para la fusi贸n
            mergeCanvas.width = canvas3D.width; // Define el ancho igual a la resoluci贸n del renderizador
            mergeCanvas.height = canvas3D.height; // Define el alto igual a la resoluci贸n del renderizador
            const ctx = mergeCanvas.getContext('2d'); // Obtiene el contexto de dibujo 2D

            // TCNICO: Fuerza al renderizador a dibujar el frame ahora mismo para que no salga vac铆o (correcci贸n para iOS)
            escena.renderer.render(escena.object3D, escena.camera); 

            // Paso 1: Dibuja la imagen de la webcam al fondo
            ctx.drawImage(video, 0, 0, mergeCanvas.width, mergeCanvas.height);
            // Paso 2: Dibuja el personaje 3D encima (preservando la transparencia)
            ctx.drawImage(canvas3D, 0, 0);

            try {
                const dataURL = mergeCanvas.toDataURL('image/png'); // Convierte el resultado en una imagen PNG
                const link = document.createElement('a'); // Crea un elemento de descarga invisible
                link.download = 'ar-foto.png'; // Nombre del archivo de salida
                link.href = dataURL; // Asigna el dato de la imagen al enlace
                link.click(); // Dispara la descarga autom谩tica
                alert("隆Foto guardada con 茅xito!");
            } catch (error) {
                console.error("Error al capturar la foto:", error);
                alert("No se pudo guardar la foto. Verifica los permisos de tu navegador.");
            }
        });

        // --- LGICA DE VDEO (GRABACIN) ---
        btnVideo.addEventListener('click', () => {
            if (!grabador || grabador.state === 'inactive') { // Verifica si no hay una grabaci贸n en curso
                const video = document.querySelector('video'); // Referencia de la webcam
                const canvas3D = escena.renderer.domElement; // Referencia del personaje
                const mergeCanvas = document.createElement('canvas'); // Canvas para procesar el v铆deo fusionado
                mergeCanvas.width = canvas3D.width; // Sincroniza dimensiones
                mergeCanvas.height = canvas3D.height;
                const ctx = mergeCanvas.getContext('2d');

                // TCNICO: Verifica formatos soportados. iOS prefiere MP4/H264 si est谩 disponible
                let tipoMime = 'video/mp4'; 
                if (!MediaRecorder.isTypeSupported(tipoMime)) {
                    tipoMime = 'video/webm;codecs=vp8'; // Est谩ndar para Chrome/Android
                }

                const stream = mergeCanvas.captureStream(30); // Captura el flujo del canvas a 30 cuadros por segundo
                try {
                    grabador = new MediaRecorder(stream, { mimeType: tipoMime }); // Inicia el grabador con el formato elegido
                } catch (e) {
                    console.error("Error al iniciar MediaRecorder:", e);
                    alert("Tu navegador no soporta la grabaci贸n de v铆deo en esta resoluci贸n o formato.");
                    return;
                }

                fragmentos = []; // Limpia el buffer de v铆deo

                grabador.ondataavailable = e => fragmentos.push(e.data); // Acumula datos conforme se generan
                grabador.onstop = () => { // Evento disparado al finalizar la grabaci贸n
                    const blob = new Blob(fragmentos, { type: tipoMime }); // Crea un archivo binario (Blob)
                    const url = URL.createObjectURL(blob); // Genera una URL para el archivo creado
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `ar-video.${tipoMime.includes('mp4') ? 'mp4' : 'webm'}`; // Define la extensi贸n correcta
                    link.click(); // Inicia la descarga
                    alert("V铆deo generado correctamente.");
                };

                grabador.start(); // Inicia el proceso de captura
                btnVideo.textContent = "癸"; // Cambia el icono a "Parar"
                btnVideo.style.background = "#ff4d4d"; // Feedback visual de grabaci贸n activa

                // BUCLE DE RENDERIZADO: Fusiona webcam y 3D fotograma a fotograma para el v铆deo
                function bucle() {
                    if (grabador && grabador.state === 'recording') {
                        ctx.drawImage(video, 0, 0, mergeCanvas.width, mergeCanvas.height); // Webcam al fondo
                        ctx.drawImage(canvas3D, 0, 0); // 3D al frente
                        requestAnimationFrame(bucle); // Llama al siguiente fotograma sincronizado con la pantalla
                    }
                }
                bucle(); // Inicia el bucle
            } else {
                grabador.stop(); // Finaliza la grabaci贸n
                btnVideo.textContent = ""; // Restaura el icono original
                btnVideo.style.background = "white"; // Restaura el color original
            }
        });

        // Evento para confirmar en consola que el personaje est谩 listo
        document.querySelector('#personagem').addEventListener('model-loaded', () => {
            console.log("Personaje 3D cargado y listo para la acci贸n.");
        });
    </script>
</body>
</html>
