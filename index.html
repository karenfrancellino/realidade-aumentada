<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

    <a-scene 
        embedded 
        vr-mode-ui="enabled: false"
        renderer="preserveDrawingBuffer: true; alpha: true;" 
        arjs="sourceType: webcam; debugUIEnabled: false;">

        <a-marker preset="hiro">
            <a-entity
                id="personagem"
                gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
                scale="2 2 2"
                position="0 0.5 0"
                animation-mixer="clip: SickJacken_rigAction; loop: repeat">
            </a-entity>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <div style="position:fixed; bottom:20px; width:100%; display:flex; justify-content:space-around; z-index:1000;">
        <button id="btnFoto" style="padding:15px; border-radius:10px; background:white; border:2px solid #ccc; font-weight:bold;">萄 Foto</button>
        <button id="btnVideo" style="padding:15px; border-radius:10px; background:white; border:2px solid #ccc; font-weight:bold;">閥 Vﾃｭdeo</button>
    </div>

    <script>
        // Declaramos as variﾃ｡veis APENAS UMA VEZ para evitar "Identifier already declared"
        const cenaAframe = document.querySelector('a-scene');
        const botaoFoto = document.querySelector('#btnFoto');
        const botaoVideo = document.querySelector('#btnVideo');
        let gravador;
        let blocosDeVideo = [];

        // --- FUNﾃﾃグ PARA CAPTURAR TELA (CﾃMERA + 3D) ---
        botaoFoto.addEventListener('click', () => {
            const videoWebcam = document.querySelector('video');
            const canvas3D = cenaAframe.renderer.domElement;
            
            const canvasFinal = document.createElement('canvas');
            canvasFinal.width = canvas3D.width;
            canvasFinal.height = canvas3D.height;
            const contexto = canvasFinal.getContext('2d');

            // Desenha a cﾃ｢mera, depois o 3D
            contexto.drawImage(videoWebcam, 0, 0, canvasFinal.width, canvasFinal.height);
            contexto.drawImage(canvas3D, 0, 0);

            const linkA = document.createElement('a');
            linkA.download = 'ar-screenshot.png';
            linkA.href = canvasFinal.toDataURL('image/png');
            linkA.click();
        });

        // --- FUNﾃﾃグ PARA GRAVAR Vﾃ好EO (CﾃMERA + 3D) ---
        botaoVideo.addEventListener('click', () => {
            if (!gravador || gravador.state === 'inactive') {
                const videoWebcam = document.querySelector('video');
                const canvas3D = cenaAframe.renderer.domElement;
                
                // Canvas intermediﾃ｡rio para o merge do vﾃｭdeo
                const canvasMerge = document.createElement('canvas');
                canvasMerge.width = canvas3D.width;
                canvasMerge.height = canvas3D.height;
                const ctxMerge = canvasMerge.getContext('2d');

                const fluxo = canvasMerge.captureStream(30);
                gravador = new MediaRecorder(fluxo, { mimeType: 'video/webm' });
                blocosDeVideo = [];

                gravador.ondataavailable = e => blocosDeVideo.push(e.data);
                gravador.onstop = () => {
                    const blob = new Blob(blocosDeVideo, { type: 'video/webm' });
                    const linkV = document.createElement('a');
                    linkV.href = URL.createObjectURL(blob);
                    linkV.download = 'ar-video.webm';
                    linkV.click();
                };

                gravador.start();
                botaoVideo.textContent = "竢ｹ Parar";
                botaoVideo.style.background = "#ffcccc";

                // Loop que desenha os dois elementos no canvas do vﾃｭdeo
                function desenharFrame() {
                    if (gravador && gravador.state === 'recording') {
                        ctxMerge.drawImage(videoWebcam, 0, 0, canvasMerge.width, canvasMerge.height);
                        ctxMerge.drawImage(canvas3D, 0, 0);
                        requestAnimationFrame(desenharFrame);
                    }
                }
                desenharFrame();
            } else {
                gravador.stop();
                botaoVideo.textContent = "閥 Vﾃｭdeo";
                botaoVideo.style.background = "white";
            }
        });

        // --- VERIFICAﾃﾃグ DE CARREGAMENTO ---
        document.querySelector('#personagem').addEventListener('model-loaded', () => {
            console.log("Boneco carregado e pronto!");
        });
    </script>
</body>
</html>
