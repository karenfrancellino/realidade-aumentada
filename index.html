<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene
      embedded
      renderer="antialias: true; colorManagement: true; preserveDrawingBuffer: true; alpha: true;"
      arjs="sourceType: webcam; debugUIEnabled: false;">

      <a-marker preset="hiro">
        <a-entity
          id="personagem"
          gltf-model="https://raw.githubusercontent.com/KarenFrancellino/ar-models/main/DROYZ_ANIMAPP_SiCkJacken_v005.glb"
          scale="2 2 2"
          position="0 0.5 0">
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
  </a-scene>

  <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:space-around; z-index:999;">
    <button id="btnFoto" style="padding:15px; background:white; border-radius:10px; border:none; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">萄 Foto</button>
    <button id="btnVideo" style="padding:15px; background:white; border-radius:10px; border:none; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">閥 Vﾃｭdeo</button>
  </div>

  <script>
    const sceneEl = document.querySelector('a-scene');
    const modelEl = document.querySelector('#personagem');
    const btnFoto = document.querySelector('#btnFoto');
    const btnVideo = document.querySelector('#btnVideo');
    let mediaRecorder;
    let chunks = [];

    // --- 1. CORREﾃﾃグ DA ANIMAﾃﾃグ ---
    modelEl.addEventListener('model-loaded', () => {
      console.log('Modelo carregado!');
      // Forﾃｧa a ativaﾃｧﾃ｣o da animaﾃｧﾃ｣o apﾃｳs o carregamento
      modelEl.setAttribute('animation-mixer', {
        clip: 'SickJacken_rigAction',
        loop: 'repeat',
        timeScale: 1
      });
    });

    // --- 2. CORREﾃﾃグ DA FOTO (CﾃMERA + 3D) ---
    btnFoto.addEventListener('click', () => {
      const video = document.querySelector('video'); // Vﾃｭdeo da AR.js
      const canvas3d = sceneEl.renderer.domElement; // Canvas do A-Frame
      
      const merger = document.createElement('canvas');
      merger.width = canvas3d.width;
      merger.height = canvas3d.height;
      const ctx = merger.getContext('2d');

      // Pequeno delay para garantir que o frame 3D estﾃ｡ no buffer
      setTimeout(() => {
        // Desenha webcam
        ctx.drawImage(video, 0, 0, merger.width, merger.height);
        // Desenha 3D
        ctx.drawImage(canvas3d, 0, 0);

        const link = document.createElement('a');
        link.download = 'minha-foto-ar.png';
        link.href = merger.toDataURL('image/png');
        link.click();
      }, 50); 
    });

    // --- 3. CORREﾃﾃグ DO Vﾃ好EO (CﾃMERA + 3D) ---
    btnVideo.addEventListener('click', () => {
      const video = document.querySelector('video');
      const canvas3d = sceneEl.renderer.domElement;
      
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        chunks = [];
        const merger = document.createElement('canvas');
        merger.width = canvas3d.width;
        merger.height = canvas3d.height;
        const ctx = merger.getContext('2d');

        // Captura o stream do canvas que estamos prestes a desenhar
        const stream = merger.captureStream(30); 
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'meu-video-ar.webm';
          a.click();
        };

        mediaRecorder.start();
        btnVideo.style.backgroundColor = '#ff4444';
        btnVideo.textContent = '竢ｹ Parar';

        // LOOP DE DESENHO SINCRONIZADO
        function draw() {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            ctx.drawImage(video, 0, 0, merger.width, merger.height); // fundo
            ctx.drawImage(canvas3d, 0, 0); // personagem
            requestAnimationFrame(draw);
          }
        }
        draw();
      } else {
        mediaRecorder.stop();
        btnVideo.style.backgroundColor = 'white';
        btnVideo.textContent = '閥 Vﾃｭdeo';
      }
    });
  </script>
</body>
</html>
